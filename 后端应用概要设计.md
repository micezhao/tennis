# 后端应用概要设计

## 1. 技术栈选型

| 类别 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 编程语言 | Java | 8 | 符合要求 |
| 框架 | Spring Boot | 2.3.x | 支持Java 8，成熟稳定 |
| 微服务框架 | Spring Cloud | Hoxton.SR12 | 服务注册与发现、配置中心、负载均衡 |
| 服务注册与发现 | Nacos | 2.0.x | 统一服务注册与配置管理 |
| API网关 | Spring Cloud Gateway | 2.3.x | 请求路由、负载均衡、限流 |
| 消息中间件 | Kafka | 2.13 | 模块间异步通信 |
| 关系型数据库 | MySQL | 8.0 | 存储用户、订单、约球、场地预约等数据 |
| 搜索引擎 | Elasticsearch | 7.10.x | 存储和查询场地信息，提高查询性能 |
| 缓存 | Redis | 6.0 | 缓存、会话管理 |
| ORM框架 | MyBatis-Plus | 3.4.x | 简化数据库操作 |
| 权限框架 | Spring Security | 5.3.x | 基于角色的权限控制，无需JWT |
| 日志 | SLF4J + Logback | - | 日志记录 |
| 接口文档 | Swagger2 | 2.9.x | API文档生成 |
| 容器化 | Docker | - | 支持容器化部署 |
| 编排 | Kubernetes | 1.21.x | 支持K8s部署 |

## 2. 项目结构

```
tennis-community/├── common/           # 公共模块│   ├── src/main/java/com/tennis/common/│   │   ├── config/       # 公共配置│   │   ├── constant/     # 常量定义│   │   ├── dto/          # 数据传输对象│   │   ├── entity/       # 基础实体类│   │   ├── exception/    # 异常处理│   │   └── utils/        # 工具类│   └── pom.xml├── gateway/         # API网关│   ├── src/main/java/com/tennis/gateway/│   ├── src/main/resources/│   └── pom.xml├── user-service/    # 用户模块│   ├── src/main/java/com/tennis/user/│   │   ├── config/       # 模块配置│   │   ├── controller/   # 控制器│   │   ├── entity/       # 实体类│   │   ├── mapper/       # Mapper接口│   │   ├── service/      # 服务层│   │   └── utils/        # 模块工具类│   ├── src/main/resources/│   └── pom.xml├── court-service/   # 球场信息模块│   ├── src/main/java/com/tennis/court/│   ├── src/main/resources/│   └── pom.xml├── match-service/   # 约球匹配模块│   ├── src/main/java/com/tennis/match/│   ├── src/main/resources/│   └── pom.xml├── ecommerce-service/ # 电商模块│   ├── src/main/java/com/tennis/ecommerce/│   ├── src/main/resources/│   └── pom.xml├── payment-service/ # 支付模块│   ├── src/main/java/com/tennis/payment/│   ├── src/main/resources/│   └── pom.xml├── docker-compose.yml  # Docker Compose配置├── k8s/              # Kubernetes部署文件│   ├── gateway.yaml│   ├── user-service.yaml│   ├── court-service.yaml│   ├── match-service.yaml│   ├── ecommerce-service.yaml│   └── payment-service.yaml└── pom.xml           # 父工程pom.xml
```

## 3. 模块划分与能力

### 3.1 用户模块

**核心能力：**
- 用户微信登录与认证
- 用户信息管理（基本信息、网球水平、球龄等）
- 角色与权限管理
- 用户信用评分管理
- 技能评估历史记录

**实体说明：**
- **User**：用户基本信息，包括微信登录信息、个人资料、网球水平等
- **UserSkillHistory**：用户技能评估历史记录，包括评估日期、等级、分数等
- **Role**：角色信息，定义用户角色
- **Permission**：权限信息，定义系统权限
- **UserRole**：用户角色关联表
- **RolePermission**：角色权限关联表

**基于微信登录的用户认证流程：**

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  微信小程序  │     │  API网关    │     │  用户模块    │     │  微信开放平台  │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
        │                   │                   │                   │
        │ 1. 发起登录请求     │                   │                   │
        ├───────────────────►│                   │                   │
        │                   │                   │                   │
        │ 2. 调用wx.login()  │                   │                   │
        │◄───────────────────┘                   │                   │
        │                   │                   │                   │
        │ 3. 获取code        │                   │                   │
        │───────────────────►│                   │                   │
        │                   │                   │                   │
        │ 4. 转发code到后端  │                   │                   │
        │◄───────────────────┘                   │                   │
        │                   │                   │                   │
        │                   │ 5. 调用微信API    │                   │
        │                   ├───────────────────►│                   │
        │                   │                   │                   │
        │                   │ 6. 获取openid和   │                   │
        │                   │    session_key    │                   │
        │                   │◄───────────────────┘                   │
        │                   │                   │                   │
        │                   │ 7. 查询用户是否   │                   │
        │                   │    已存在        │                   │
        │                   │───────────────────►│                   │
        │                   │                   │                   │
        │                   │ 8. 创建或获取    │                   │
        │                   │    用户信息      │                   │
        │                   │◄───────────────────┘                   │
        │                   │                   │                   │
        │                   │ 9. Spring Security │                   │
        │                   │  生成认证对象     │                   │
        │                   │───────────────────►│                   │
        │                   │                   │                   │
        │                   │ 10. 返回认证结果  │                   │
        │                   │◄───────────────────┘                   │
        │                   │                   │                   │
        │ 11. 返回登录结果   │                   │                   │
        │◄───────────────────┘                   │                   │
        │                   │                   │                   │
        │ 12. 保存登录状态   │                   │                   │
        └───────────────────────────────────────────────────────────┘
```

**详细流程说明：**
1. 用户通过微信小程序发起登录请求
2. 小程序调用微信API `wx.login()` 获取临时登录凭证 `code`
3. 小程序将 `code` 发送到后端登录接口
4. API网关将请求转发到用户模块
5. 用户模块使用 `code` 调用微信开放平台API `auth.code2Session`
6. 微信开放平台返回 `openid` 和 `session_key`
7. 用户模块根据 `openid` 查询数据库，判断用户是否已存在
8. 若用户不存在：创建新用户，生成用户ID，保存 `openid`
   若用户存在：获取现有用户ID
9. 用户模块使用Spring Security生成认证对象，存储用户信息到SecurityContext
10. 用户模块返回认证结果
11. API网关将结果返回给小程序
12. 小程序保存登录状态，后续请求携带认证信息

### 3.2 球场信息模块

**核心能力：**
- 球场信息管理（基本信息、地址、联系方式、营业时间）
- 场地信息管理（场地类型、数量、配套设施）
- 实时可用时段管理
- 球场预约管理
- 球场评价管理
- 球场信息同步到ES

**实体说明：**
- **Court**：球场基本信息，包括名称、地址、联系方式、营业时间等
- **CourtField**：场地信息，包括场地类型、是否室内、是否有灯光等
- **AvailableSlot**：可用时段，记录场地的可用时间和价格
- **CourtReview**：球场评价，记录用户对球场的评分和评价内容
- **CourtBooking**：球场预约，记录用户的场地预约信息

### 3.3 约球匹配模块

**核心能力：**
- 约球信息发布与管理
- 约球活动列表与筛选
- 约球报名与审核
- 约球活动状态管理
- 约球匹配算法

**实体说明：**
- **MatchActivity**：约球活动，记录约球的基本信息，包括时间、地点、水平要求等
- **MatchSignup**：约球报名，记录用户的报名信息和审核状态
- **MatchComment**：约球活动评价，记录用户对约球活动的评价

### 3.4 电商模块

**核心能力：**
- 商品信息发布与管理
- 商品列表与搜索
- 商品订单管理
- 商品交付管理

**实体说明：**
- **Product**：商品信息，包括商品名称、描述、价格、库存等
- **ProductOrder**：商品订单，记录用户的商品购买信息
- **ProductComment**：商品评价，记录用户对商品的评价

### 3.5 支付模块

**核心能力：**
- 订单管理（约球订单、球场预约订单、商品订单）
- 支付渠道对接（微信支付）
- 支付状态管理
- 退款管理
- 交易记录查询

**实体说明：**
- **Order**：通用订单，记录所有类型的订单信息
- **PaymentTransaction**：支付交易，记录支付的详细信息和状态
- **Refund**：退款记录，记录退款的申请和处理状态

## 4. 数据库设计

### 4.1 关系型数据库（MySQL）

#### 4.1.1 用户模块表结构

**1. 用户表（user）**
```sql
CREATE TABLE `user` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '用户ID',
  `open_id` VARCHAR(128) NOT NULL UNIQUE COMMENT '微信openId',
  `nick_name` VARCHAR(64) NOT NULL COMMENT '昵称',
  `avatar_url` VARCHAR(512) COMMENT '头像URL',
  `gender` TINYINT DEFAULT 0 COMMENT '性别：0未知，1男，2女',
  `age` INT DEFAULT 0 COMMENT '年龄',
  `level` VARCHAR(10) COMMENT '网球水平（NTRP等级）',
  `tennis_age` INT DEFAULT 0 COMMENT '球龄（年）',
  `bio` TEXT COMMENT '个人简介',
  `credit_score` INT DEFAULT 100 COMMENT '信用评分',
  `status` TINYINT DEFAULT 1 COMMENT '状态：1正常，0禁用',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

**2. 用户技能评估历史表（user_skill_history）**
```sql
CREATE TABLE `user_skill_history` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '历史记录ID',
  `user_id` VARCHAR(32) NOT NULL COMMENT '用户ID',
  `assessment_date` DATE NOT NULL COMMENT '评估日期',
  `level` VARCHAR(10) NOT NULL COMMENT '评估等级',
  `score` INT DEFAULT 0 COMMENT '评估分数',
  `video_url` VARCHAR(512) COMMENT '技能视频URL',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户技能评估历史表';
```

**3. 角色表（role）**
```sql
CREATE TABLE `role` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '角色ID',
  `role_name` VARCHAR(64) NOT NULL UNIQUE COMMENT '角色名称',
  `description` VARCHAR(256) COMMENT '角色描述',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色表';
```

**4. 权限表（permission）**
```sql
CREATE TABLE `permission` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '权限ID',
  `permission_name` VARCHAR(64) NOT NULL COMMENT '权限名称',
  `url` VARCHAR(256) NOT NULL COMMENT '接口URL',
  `method` VARCHAR(10) NOT NULL COMMENT '请求方法',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='权限表';
```

**5. 用户角色关联表（user_role）**
```sql
CREATE TABLE `user_role` (
  `user_id` VARCHAR(32) NOT NULL COMMENT '用户ID',
  `role_id` VARCHAR(32) NOT NULL COMMENT '角色ID',
  PRIMARY KEY (`user_id`, `role_id`),
  FOREIGN KEY (`user_id`) REFERENCES `user` (`id`),
  FOREIGN KEY (`role_id`) REFERENCES `role` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关联表';
```

**6. 角色权限关联表（role_permission）**
```sql
CREATE TABLE `role_permission` (
  `role_id` VARCHAR(32) NOT NULL COMMENT '角色ID',
  `permission_id` VARCHAR(32) NOT NULL COMMENT '权限ID',
  PRIMARY KEY (`role_id`, `permission_id`),
  FOREIGN KEY (`role_id`) REFERENCES `role` (`id`),
  FOREIGN KEY (`permission_id`) REFERENCES `permission` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色权限关联表';
```

#### 4.1.2 球场信息模块表结构

**1. 球场表（court）**
```sql
CREATE TABLE `court` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '球场ID',
  `name` VARCHAR(128) NOT NULL COMMENT '球场名称',
  `address` VARCHAR(256) NOT NULL COMMENT '地址',
  `latitude` DECIMAL(10, 6) NOT NULL COMMENT '纬度',
  `longitude` DECIMAL(10, 6) NOT NULL COMMENT '经度',
  `phone` VARCHAR(20) COMMENT '联系电话',
  `business_hours` VARCHAR(128) COMMENT '营业时间',
  `rating` DECIMAL(3, 1) DEFAULT 0 COMMENT '评分',
  `review_count` INT DEFAULT 0 COMMENT '评价数量',
  `available` BOOLEAN DEFAULT TRUE COMMENT '是否可用',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='球场表';
```

**2. 场地表（court_field）**
```sql
CREATE TABLE `court_field` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '场地ID',
  `court_id` VARCHAR(32) NOT NULL COMMENT '球场ID',
  `field_name` VARCHAR(64) NOT NULL COMMENT '场地名称',
  `surface_type` VARCHAR(20) NOT NULL COMMENT '场地类型：硬地、红土、草地',
  `indoor` BOOLEAN DEFAULT FALSE COMMENT '是否室内',
  `has_lights` BOOLEAN DEFAULT FALSE COMMENT '是否有灯光',
  `price_per_hour` DECIMAL(10, 2) NOT NULL COMMENT '每小时价格',
  `status` TINYINT DEFAULT 1 COMMENT '状态：1可用，0不可用',
  FOREIGN KEY (`court_id`) REFERENCES `court` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='场地表';
```

**3. 可用时段表（available_slot）**
```sql
CREATE TABLE `available_slot` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '时段ID',
  `court_id` VARCHAR(32) NOT NULL COMMENT '球场ID',
  `field_id` VARCHAR(32) NOT NULL COMMENT '场地ID',
  `date` DATE NOT NULL COMMENT '日期',
  `start_time` TIME NOT NULL COMMENT '开始时间',
  `end_time` TIME NOT NULL COMMENT '结束时间',
  `available` BOOLEAN DEFAULT TRUE COMMENT '是否可用',
  `price` DECIMAL(10, 2) NOT NULL COMMENT '价格',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  FOREIGN KEY (`court_id`) REFERENCES `court` (`id`),
  FOREIGN KEY (`field_id`) REFERENCES `court_field` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='可用时段表';
```

**4. 球场评价表（court_review）**
```sql
CREATE TABLE `court_review` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '评价ID',
  `court_id` VARCHAR(32) NOT NULL COMMENT '球场ID',
  `user_id` VARCHAR(32) NOT NULL COMMENT '用户ID',
  `rating` INT NOT NULL COMMENT '评分：1-5',
  `content` TEXT COMMENT '评价内容',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  FOREIGN KEY (`court_id`) REFERENCES `court` (`id`),
  FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='球场评价表';
```

**5. 球场预约表（court_booking）**
```sql
CREATE TABLE `court_booking` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '预约ID',
  `user_id` VARCHAR(32) NOT NULL COMMENT '用户ID',
  `court_id` VARCHAR(32) NOT NULL COMMENT '球场ID',
  `field_id` VARCHAR(32) NOT NULL COMMENT '场地ID',
  `booking_date` DATE NOT NULL COMMENT '预约日期',
  `start_time` TIME NOT NULL COMMENT '开始时间',
  `end_time` TIME NOT NULL COMMENT '结束时间',
  `total_price` DECIMAL(10, 2) NOT NULL COMMENT '总价',
  `status` VARCHAR(20) DEFAULT 'CREATED' COMMENT '状态：CREATED已创建，PAID已支付，CANCELED已取消，COMPLETED已完成',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `paid_at` DATETIME COMMENT '支付时间',
  `canceled_at` DATETIME COMMENT '取消时间',
  FOREIGN KEY (`user_id`) REFERENCES `user` (`id`),
  FOREIGN KEY (`court_id`) REFERENCES `court` (`id`),
  FOREIGN KEY (`field_id`) REFERENCES `court_field` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='球场预约表';
```

#### 4.1.3 约球匹配模块表结构

**1. 约球活动表（match_activity）**
```sql
CREATE TABLE `match_activity` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '约球ID',
  `publisher_id` VARCHAR(32) NOT NULL COMMENT '发布者ID',
  `court_id` VARCHAR(32) NOT NULL COMMENT '球场ID',
  `court_name` VARCHAR(128) NOT NULL COMMENT '球场名称',
  `date` DATE NOT NULL COMMENT '日期',
  `start_time` TIME NOT NULL COMMENT '开始时间',
  `end_time` TIME NOT NULL COMMENT '结束时间',
  `match_type` VARCHAR(20) NOT NULL COMMENT '约球类型：单打、双打、练球',
  `level_min` INT DEFAULT 0 COMMENT '最低水平要求',
  `level_max` INT DEFAULT 7 COMMENT '最高水平要求',
  `current_players` INT DEFAULT 1 COMMENT '当前参与人数',
  `max_players` INT NOT NULL COMMENT '最大参与人数',
  `cost_type` VARCHAR(20) NOT NULL COMMENT '费用类型：AA制、群主请客、定额',
  `cost_per_person` DECIMAL(10, 2) DEFAULT 0 COMMENT '每人费用',
  `description` TEXT COMMENT '活动描述',
  `status` VARCHAR(20) DEFAULT 'PENDING' COMMENT '状态：PENDING待开始，ACTIVE进行中，COMPLETED已完成，CANCELED已取消',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (`publisher_id`) REFERENCES `user` (`id`),
  FOREIGN KEY (`court_id`) REFERENCES `court` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='约球活动表';
```

**2. 约球报名表（match_signup）**
```sql
CREATE TABLE `match_signup` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '报名ID',
  `match_id` VARCHAR(32) NOT NULL COMMENT '约球ID',
  `user_id` VARCHAR(32) NOT NULL COMMENT '用户ID',
  `video_url` VARCHAR(512) COMMENT '技能视频URL',
  `message` TEXT COMMENT '留言',
  `status` VARCHAR(20) DEFAULT 'APPLIED' COMMENT '状态：APPLIED已报名，APPROVED已通过，REJECTED已拒绝，CANCELED已取消',
  `approved` BOOLEAN DEFAULT FALSE COMMENT '是否通过审核',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (`match_id`) REFERENCES `match_activity` (`id`),
  FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='约球报名表';
```

**3. 约球评价表（match_comment）**
```sql
CREATE TABLE `match_comment` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '评价ID',
  `match_id` VARCHAR(32) NOT NULL COMMENT '约球ID',
  `user_id` VARCHAR(32) NOT NULL COMMENT '用户ID',
  `target_user_id` VARCHAR(32) NOT NULL COMMENT '被评价用户ID',
  `rating` INT NOT NULL COMMENT '评分：1-5',
  `content` TEXT COMMENT '评价内容',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  FOREIGN KEY (`match_id`) REFERENCES `match_activity` (`id`),
  FOREIGN KEY (`user_id`) REFERENCES `user` (`id`),
  FOREIGN KEY (`target_user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='约球评价表';
```

#### 4.1.4 支付模块表结构

**1. 订单表（order）**
```sql
CREATE TABLE `order` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '订单ID',
  `user_id` VARCHAR(32) NOT NULL COMMENT '用户ID',
  `type` VARCHAR(20) NOT NULL COMMENT '订单类型：COURT_BOOKING球场预约，MATCH_SIGNUP约球报名，PRODUCT商品订单',
  `target_id` VARCHAR(32) NOT NULL COMMENT '目标ID（球场预约ID、约球ID、商品ID）',
  `amount` DECIMAL(10, 2) NOT NULL COMMENT '订单金额',
  `status` VARCHAR(20) DEFAULT 'CREATED' COMMENT '状态：CREATED已创建，PAID已支付，CANCELED已取消，REFUNDED已退款',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `paid_at` DATETIME COMMENT '支付时间',
  `canceled_at` DATETIME COMMENT '取消时间',
  `refunded_at` DATETIME COMMENT '退款时间',
  FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';
```

**2. 支付交易表（payment_transaction）**
```sql
CREATE TABLE `payment_transaction` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '交易ID',
  `order_id` VARCHAR(32) NOT NULL COMMENT '订单ID',
  `payment_method` VARCHAR(20) NOT NULL COMMENT '支付方式：WECHAT_PAY微信支付',
  `transaction_no` VARCHAR(128) COMMENT '第三方交易单号',
  `amount` DECIMAL(10, 2) NOT NULL COMMENT '交易金额',
  `status` VARCHAR(20) DEFAULT 'INITIATED' COMMENT '状态：INITIATED已发起，SUCCESS成功，FAILED失败，REFUNDED已退款',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `completed_at` DATETIME COMMENT '完成时间',
  FOREIGN KEY (`order_id`) REFERENCES `order` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='支付交易表';
```

**3. 退款表（refund）**
```sql
CREATE TABLE `refund` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '退款ID',
  `order_id` VARCHAR(32) NOT NULL COMMENT '订单ID',
  `transaction_id` VARCHAR(32) NOT NULL COMMENT '支付交易ID',
  `refund_no` VARCHAR(128) COMMENT '退款单号',
  `amount` DECIMAL(10, 2) NOT NULL COMMENT '退款金额',
  `reason` TEXT COMMENT '退款原因',
  `status` VARCHAR(20) DEFAULT 'APPLIED' COMMENT '状态：APPLIED已申请，PROCESSING处理中，SUCCESS成功，FAILED失败',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `processed_at` DATETIME COMMENT '处理时间',
  FOREIGN KEY (`order_id`) REFERENCES `order` (`id`),
  FOREIGN KEY (`transaction_id`) REFERENCES `payment_transaction` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='退款表';
```

#### 4.1.5 电商模块表结构

**1. 商品表（product）**
```sql
CREATE TABLE `product` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '商品ID',
  `name` VARCHAR(128) NOT NULL COMMENT '商品名称',
  `description` TEXT COMMENT '商品描述',
  `price` DECIMAL(10, 2) NOT NULL COMMENT '商品价格',
  `stock` INT NOT NULL COMMENT '库存',
  `status` TINYINT DEFAULT 1 COMMENT '状态：1上架，0下架',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品表';
```

**2. 商品订单表（product_order）**
```sql
CREATE TABLE `product_order` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '商品订单ID',
  `order_id` VARCHAR(32) NOT NULL COMMENT '通用订单ID',
  `product_id` VARCHAR(32) NOT NULL COMMENT '商品ID',
  `quantity` INT NOT NULL COMMENT '数量',
  `unit_price` DECIMAL(10, 2) NOT NULL COMMENT '单价',
  `total_price` DECIMAL(10, 2) NOT NULL COMMENT '总价',
  FOREIGN KEY (`order_id`) REFERENCES `order` (`id`),
  FOREIGN KEY (`product_id`) REFERENCES `product` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品订单表';
```

**3. 商品评价表（product_comment）**
```sql
CREATE TABLE `product_comment` (
  `id` VARCHAR(32) NOT NULL PRIMARY KEY COMMENT '评价ID',
  `product_id` VARCHAR(32) NOT NULL COMMENT '商品ID',
  `user_id` VARCHAR(32) NOT NULL COMMENT '用户ID',
  `rating` INT NOT NULL COMMENT '评分：1-5',
  `content` TEXT COMMENT '评价内容',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  FOREIGN KEY (`product_id`) REFERENCES `product` (`id`),
  FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品评价表';
```

### 4.2 搜索引擎（Elasticsearch）

#### 4.2.1 球场索引（court）

**映射（Mapping）：**
```json
{
  "mappings": {
    "properties": {
      "courtId": {
        "type": "keyword"
      },
      "name": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "address": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "latitude": {
        "type": "double"
      },
      "longitude": {
        "type": "double"
      },
      "phone": {
        "type": "keyword"
      },
      "businessHours": {
        "type": "keyword"
      },
      "rating": {
        "type": "double"
      },
      "reviewCount": {
        "type": "integer"
      },
      "available": {
        "type": "boolean"
      },
      "fields": {
        "type": "nested",
        "properties": {
          "fieldId": {
            "type": "keyword"
          },
          "fieldName": {
            "type": "keyword"
          },
          "surfaceType": {
            "type": "keyword"
          },
          "indoor": {
            "type": "boolean"
          },
          "hasLights": {
            "type": "boolean"
          },
          "pricePerHour": {
            "type": "double"
          }
        }
      },
      "reviews": {
        "type": "nested",
        "properties": {
          "reviewId": {
            "type": "keyword"
          },
          "userId": {
            "type": "keyword"
          },
          "userName": {
            "type": "keyword"
          },
          "userAvatar": {
            "type": "keyword"
          },
          "rating": {
            "type": "integer"
          },
          "content": {
            "type": "text",
            "analyzer": "ik_max_word",
            "search_analyzer": "ik_smart"
          },
          "createdAt": {
            "type": "date"
          }
        }
      },
      "createdAt": {
        "type": "date"
      },
      "updatedAt": {
        "type": "date"
      }
    }
  }
}
```

**文档示例：**
```json
{
  "courtId": "court_123",
  "name": "网球中心",
  "address": "北京市朝阳区建国路123号",
  "latitude": 39.9087,
  "longitude": 116.4074,
  "phone": "010-12345678",
  "businessHours": "08:00-22:00",
  "rating": 4.8,
  "reviewCount": 120,
  "available": true,
  "fields": [
    {
      "fieldId": "field_001",
      "fieldName": "场地1",
      "surfaceType": "硬地",
      "indoor": false,
      "hasLights": true,
      "pricePerHour": 120.0
    },
    {
      "fieldId": "field_002",
      "fieldName": "场地2",
      "surfaceType": "红土",
      "indoor": false,
      "hasLights": true,
      "pricePerHour": 150.0
    }
  ],
  "reviews": [
    {
      "reviewId": "review_001",
      "userId": "user_123",
      "userName": "网球爱好者",
      "userAvatar": "https://example.com/avatar.jpg",
      "rating": 5,
      "content": "场地非常好，灯光充足，服务周到",
      "createdAt": "2025-12-30T10:00:00Z"
    }
  ],
  "createdAt": "2025-12-30T00:00:00Z",
  "updatedAt": "2025-12-30T00:00:00Z"
}
```

#### 4.2.2 球场评价索引（court_review）

**映射（Mapping）：**
```json
{
  "mappings": {
    "properties": {
      "reviewId": {
        "type": "keyword"
      },
      "courtId": {
        "type": "keyword"
      },
      "userId": {
        "type": "keyword"
      },
      "userName": {
        "type": "keyword"
      },
      "userAvatar": {
        "type": "keyword"
      },
      "rating": {
        "type": "integer"
      },
      "content": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "createdAt": {
        "type": "date"
      }
    }
  }
}
```

**文档示例：**
```json
{
  "reviewId": "review_001",
  "courtId": "court_123",
  "userId": "user_123",
  "userName": "网球爱好者",
  "userAvatar": "https://example.com/avatar.jpg",
  "rating": 5,
  "content": "场地非常好，灯光充足，服务周到",
  "createdAt": "2025-12-30T10:00:00Z"
}
```

#### 4.2.3 约球活动索引（match_activity）

**映射（Mapping）：**
```json
{
  "mappings": {
    "properties": {
      "matchId": {
        "type": "keyword"
      },
      "publisherId": {
        "type": "keyword"
      },
      "publisherName": {
        "type": "keyword"
      },
      "courtId": {
        "type": "keyword"
      },
      "courtName": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "address": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "latitude": {
        "type": "double"
      },
      "longitude": {
        "type": "double"
      },
      "date": {
        "type": "date",
        "format": "yyyy-MM-dd"
      },
      "startTime": {
        "type": "keyword"
      },
      "endTime": {
        "type": "keyword"
      },
      "matchType": {
        "type": "keyword"
      },
      "levelMin": {
        "type": "integer"
      },
      "levelMax": {
        "type": "integer"
      },
      "currentPlayers": {
        "type": "integer"
      },
      "maxPlayers": {
        "type": "integer"
      },
      "costType": {
        "type": "keyword"
      },
      "costPerPerson": {
        "type": "double"
      },
      "description": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "status": {
        "type": "keyword"
      },
      "createdAt": {
        "type": "date"
      },
      "updatedAt": {
        "type": "date"
      }
    }
  }
}
```

**文档示例：**
```json
{
  "matchId": "match_123",
  "publisherId": "user_123",
  "publisherName": "网球爱好者",
  "courtId": "court_123",
  "courtName": "网球中心",
  "address": "北京市朝阳区建国路123号",
  "latitude": 39.9087,
  "longitude": 116.4074,
  "date": "2025-12-31",
  "startTime": "14:00",
  "endTime": "16:00",
  "matchType": "双打",
  "levelMin": 3,
  "levelMax": 5,
  "currentPlayers": 2,
  "maxPlayers": 4,
  "costType": "AA制",
  "costPerPerson": 60.0,
  "description": "周末双打约球，欢迎3.0-5.0水平的球友参加",
  "status": "PENDING",
  "createdAt": "2025-12-30T10:00:00Z",
  "updatedAt": "2025-12-30T10:00:00Z"
}
```

## 5. 接口设计

### 5.1 用户模块接口

| 接口名称 | 方法 | URL | 模块 | 功能描述 |
|---------|------|-----|------|---------|
| 用户登录 | POST | /api/user/login | 用户模块 | 微信登录 |
| 获取用户信息 | GET | /api/user/info | 用户模块 | 获取当前用户信息 |
| 更新用户信息 | PUT | /api/user/info | 用户模块 | 更新用户信息 |
| 获取技能评估历史 | GET | /api/user/skill-history | 用户模块 | 获取用户技能评估历史 |
| 提交技能评估 | POST | /api/user/skill-assessment | 用户模块 | 提交技能评估视频，获取评估结果 |

### 5.2 球场信息模块接口

| 接口名称 | 方法 | URL | 模块 | 功能描述 |
|---------|------|-----|------|---------|
| 球场列表 | GET | /api/court/list | 球场信息模块 | 从ES获取球场列表，支持筛选和排序 |
| 球场详情 | GET | /api/court/:id | 球场信息模块 | 从ES获取球场详情 |
| 获取可用时段 | GET | /api/court/:id/available-slots | 球场信息模块 | 从MySQL获取球场可用时段 |
| 预约球场 | POST | /api/court/:id/book | 球场信息模块 | 预约球场，保存到MySQL |
| 获取球场评价 | GET | /api/court/:id/reviews | 球场信息模块 | 从ES获取球场评价 |
| 提交球场评价 | POST | /api/court/:id/review | 球场信息模块 | 提交球场评价，同时保存到MySQL和ES |

### 5.3 约球匹配模块接口

| 接口名称 | 方法 | URL | 模块 | 功能描述 |
|---------|------|-----|------|---------|
| 发布约球 | POST | /api/match/publish | 约球匹配模块 | 发布约球信息，保存到MySQL |
| 约球列表 | GET | /api/match/list | 约球匹配模块 | 获取约球列表，支持筛选和排序 |
| 约球详情 | GET | /api/match/:id | 约球匹配模块 | 获取约球详情 |
| 报名约球 | POST | /api/match/:id/join | 约球匹配模块 | 报名约球，保存到MySQL |
| 取消报名 | POST | /api/match/:id/cancel | 约球匹配模块 | 取消约球报名 |
| 我的约球 | GET | /api/match/my | 约球匹配模块 | 获取我发布的约球 |
| 我报名的约球 | GET | /api/match/joined | 约球匹配模块 | 获取我报名的约球 |
| 审核报名 | POST | /api/match/:id/approve | 约球匹配模块 | 审核约球报名 |
| 更新约球状态 | PUT | /api/match/:id/status | 约球匹配模块 | 更新约球活动状态 |

### 5.4 支付模块接口

| 接口名称 | 方法 | URL | 模块 | 功能描述 |
|---------|------|-----|------|---------|
| 创建订单 | POST | /api/order/create | 支付模块 | 创建订单 |
| 订单列表 | GET | /api/order/list | 支付模块 | 获取订单列表 |
| 订单详情 | GET | /api/order/:id | 支付模块 | 获取订单详情 |
| 取消订单 | POST | /api/order/:id/cancel | 支付模块 | 取消订单 |
| 发起支付 | POST | /api/payment/pay | 支付模块 | 发起支付请求 |
| 支付回调 | POST | /api/payment/callback | 支付模块 | 处理支付回调 |
| 申请退款 | POST | /api/payment/refund | 支付模块 | 申请退款 |

## 6. 模块间通信设计

### 6.1 同步通信

使用Spring Cloud OpenFeign实现模块间的同步调用：

- 用户模块 → 其他模块：获取用户信息、验证权限
- 约球匹配模块 → 球场信息模块：获取球场详情、验证可用时段
- 约球匹配模块 → 支付模块：创建约球订单
- 球场信息模块 → 支付模块：创建场地预约订单

### 6.2 异步通信

使用Kafka实现模块间的异步通信，主要用于事件通知和数据同步：

| 主题名称 | 生产者 | 消费者 | 用途 |
|----------|--------|--------|------|
| user_registered | 用户模块 | 所有模块 | 用户注册通知 |
| court_created | 球场信息模块 | ES同步服务 | 球场创建，同步到ES |
| court_updated | 球场信息模块 | ES同步服务 | 球场更新，同步到ES |
| court_review_added | 球场信息模块 | ES同步服务 | 球场评价添加，同步到ES |
| match_published | 约球匹配模块 | 推送服务 | 约球发布通知 |
| match_signup_applied | 约球匹配模块 | 约球匹配模块（发布者） | 约球报名申请通知 |
| order_created | 支付模块 | 推送服务 | 订单创建通知 |
| payment_success | 支付模块 | 约球匹配模块、球场信息模块、电商模块 | 支付成功通知 |
| payment_refunded | 支付模块 | 约球匹配模块、球场信息模块、电商模块 | 退款成功通知 |

## 7. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                            API Gateway                              │
└─────────────────────────────────────────────────────────────────────┘
                    ↑               ↑               ↑
                    │               │               │
┌─────────────────┐  │  ┌─────────────────┐  ┌─────────────────┐
│   用户模块      │  │  │  球场信息模块   │  │  约球匹配模块   │
└─────────────────┘  │  └─────────────────┘  └─────────────────┘
                    │               ↑               ↑
                    │               │               │
┌─────────────────┐  │  ┌─────────────────┐  ┌─────────────────┐
│   支付模块      │◄─┴─►│   电商模块      │  │   推送服务      │
└─────────────────┘     └─────────────────┘  └─────────────────┘
          ↑
          │
┌─────────────────┐
│   微信支付      │
└─────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                          Nacos (服务注册与配置中心)                 │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   MySQL         │     │   Redis         │     │   Kafka         │
└─────────────────┘     └─────────────────┘     └─────────────────┘
          ↑                     ↑                     ↑
          │                     │                     │
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Elasticsearch │     │   Docker        │     │   Kubernetes    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

## 8. 部署架构

### 8.1 Docker部署

每个微服务都提供Dockerfile，支持容器化部署：

```dockerfile
# 示例Dockerfile
FROM openjdk:8-jre-alpine
COPY target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

### 8.2 Kubernetes部署

提供K8s部署文件，包括：
- Deployment：定义应用的Pod模板
- Service：定义服务的访问方式
- Ingress：定义HTTP路由规则
- ConfigMap：配置管理
- Secret：敏感信息管理
- HPA：水平扩展配置

## 9. 安全性设计

1. **认证与授权**：
   - 使用Spring Security进行身份认证和授权
   - 基于角色的权限控制（RBAC）
   - 敏感接口需验证权限

2. **数据安全**：
   - 敏感数据传输加密（HTTPS）
   - 数据库敏感字段加密存储

3. **接口安全**：
   - 接口限流防止DoS攻击
   - 输入参数校验防止注入攻击

4. **支付安全**：
   - 严格遵循微信支付安全规范
   - 支付回调验证
   - 交易日志完整记录

## 10. 性能优化设计

1. **缓存设计**：
   - 使用Redis缓存热点数据（用户信息、订单信息）
   - 缓存过期时间合理设置
   - 缓存预热机制

2. **数据库优化**：
   - 合理设计索引
   - 读写分离（后续数据量大时）

3. **ES优化**：
   - 合理设计索引结构
   - 使用批量操作提高写入性能
   - 优化查询语句

4. **异步处理**：
   - 耗时操作异步化（如发送通知、生成报表）
   - 使用Kafka处理事件流

5. **并发设计**：
   - 合理使用线程池
   - 分布式锁解决并发问题

## 11. 监控与日志设计

1. **监控**：
   - 使用Spring Boot Actuator暴露监控端点
   - 集成Prometheus + Grafana实现指标监控
   - 关键业务指标监控（如支付成功率、约球发布量）
   - Kubernetes监控（使用Metrics Server + Prometheus）

2. **日志**：
   - 统一日志格式
   - 日志分级（DEBUG, INFO, WARN, ERROR）
   - 日志集中存储（ELK Stack）
   - 链路追踪（Spring Cloud Sleuth + Zipkin）

## 12. 后续扩展计划

1. **微服务拆分**：根据业务发展，进一步拆分微服务
2. **引入服务网格**：使用Istio增强服务治理能力
3. **数据仓库**：构建数据仓库，支持数据分析和报表
4. **AI能力**：引入AI进行球技评估、智能约球匹配
5. **多端支持**：支持Web端、App端

## 13. 风险评估与应对

1. **数据一致性风险**：
   - 应对：MySQL与ES之间的数据同步采用最终一致性
   - 使用Kafka确保数据同步的可靠性

2. **服务雪崩风险**：
   - 应对：实现服务熔断、降级、限流
   - 合理设置超时时间

3. **微信支付风险**：
   - 应对：严格遵循微信支付安全规范
   - 定期进行安全审计

4. **用户隐私风险**：
   - 应对：遵循GDPR等隐私法规
   - 实现数据脱敏
   - 提供用户数据管理功能

5. **系统可用性风险**：
   - 应对：多副本部署
   - 实现自动故障转移
   - 定期进行灾难恢复演练

---

**文档版本**：v1.0
**编制日期**：2025-12-30
**编制人**：AI Assistant
**审核人**：待定